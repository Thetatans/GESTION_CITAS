================================================================================
    DOCUMENTACIÓN DEL SISTEMA DE AUTENTICACIÓN Y GESTIÓN DE ROLES
    Sistema de Gestión de Citas - Barbería
================================================================================

FECHA: Noviembre 2024
DESARROLLADOR: Claude AI Assistant
FRAMEWORK: CodeIgniter 4

================================================================================
1. RESUMEN DEL SISTEMA IMPLEMENTADO
================================================================================

Se ha implementado un sistema completo de autenticación y autorización con
los siguientes componentes:

✓ Sistema de Login y Logout
✓ Gestión de Roles (Administrador, Empleado/Barbero, Cliente)
✓ Filtros de Seguridad por Perfil
✓ Protección de Rutas según Rol
✓ Hash Seguro de Contraseñas (bcrypt)
✓ Sesiones con CodeIgniter 4

================================================================================
2. ESTRUCTURA DE LA BASE DE DATOS
================================================================================

2.1. TABLA: usuarios
--------------------
Esta es la tabla principal de autenticación que almacena las credenciales
de todos los usuarios del sistema.

Campos:
- id_usuario (INT, PK, AUTO_INCREMENT): Identificador único
- email (VARCHAR 255, UNIQUE): Correo electrónico para login
- password (VARCHAR 255): Contraseña hasheada con bcrypt
- rol (ENUM): 'admin', 'empleado', 'cliente'
- activo (TINYINT): 1 = activo, 0 = inactivo
- ultimo_acceso (DATETIME): Fecha del último login
- fecha_registro (DATETIME): Fecha de creación del usuario

Índices:
- idx_email: Para búsquedas rápidas por email
- idx_rol: Para filtrar por tipo de usuario
- idx_activo: Para filtrar usuarios activos/inactivos


2.2. TABLA: administradores
---------------------------
Almacena información adicional del perfil de administradores.

Campos:
- id_admin (INT, PK, AUTO_INCREMENT)
- id_usuario (INT, FK): Referencia a usuarios.id_usuario
- nombre (VARCHAR 100)
- apellido (VARCHAR 100)
- telefono (VARCHAR 20)
- cargo (VARCHAR 100): Ej: "Gerente General"
- created_at, updated_at (DATETIME)


2.3. TABLA: empleados
---------------------
Almacena información adicional del perfil de empleados/barberos.

Campos:
- id_empleado (INT, PK, AUTO_INCREMENT)
- id_usuario (INT, FK): Referencia a usuarios.id_usuario
- nombre (VARCHAR 100)
- apellido (VARCHAR 100)
- telefono (VARCHAR 20)
- especialidad (VARCHAR 100): Ej: "Corte de cabello"
- comision_porcentaje (DECIMAL 5,2): Porcentaje de comisión
- fecha_contratacion (DATE)
- created_at, updated_at (DATETIME)


2.4. TABLA: clientes
--------------------
Almacena información adicional del perfil de clientes.

Campos:
- id_cliente (INT, PK, AUTO_INCREMENT)
- id_usuario (INT, FK): Referencia a usuarios.id_usuario
- nombre (VARCHAR 100)
- apellido (VARCHAR 100)
- telefono (VARCHAR 20)
- fecha_nacimiento (DATE)
- genero (VARCHAR 20)
- direccion (TEXT)
- created_at, updated_at (DATETIME)


================================================================================
3. MODELOS (MODELS)
================================================================================

3.1. UsuarioModel.php
---------------------
Ubicación: app/Models/UsuarioModel.php

PROPÓSITO:
Gestiona todas las operaciones relacionadas con usuarios, autenticación
y autorización.

CARACTERÍSTICAS PRINCIPALES:

a) Configuración del Modelo:
   - Tabla: 'usuarios'
   - Clave primaria: 'id_usuario'
   - Tipo de retorno: array
   - Campos permitidos: email, password, rol, activo, ultimo_acceso

b) Seguridad Automática:
   - Callback beforeInsert: hashPassword()
   - Callback beforeUpdate: hashPassword()
   - Hashea contraseñas automáticamente con bcrypt

c) Reglas de Validación:
   - Email: obligatorio, formato válido, único
   - Password: obligatorio, mínimo 8 caracteres
   - Rol: obligatorio, debe ser admin/empleado/cliente

d) Métodos Personalizados:

   buscarPorEmail($email)
   - Busca un usuario por su email
   - Retorna: array con datos del usuario o null

   verificarCredenciales($email, $password)
   - Verifica email y contraseña para login
   - Verifica que el usuario esté activo
   - Usa password_verify() para seguridad
   - Retorna: array del usuario si válido, false si no

   actualizarUltimoAcceso($id_usuario)
   - Actualiza la fecha del último login
   - Se llama después de un login exitoso

   esAdmin($id_usuario)
   - Verifica si un usuario es administrador
   - Retorna: boolean

   esEmpleado($id_usuario)
   - Verifica si un usuario es empleado
   - Retorna: boolean

   esCliente($id_usuario)
   - Verifica si un usuario es cliente
   - Retorna: boolean

   obtenerPorRol($rol)
   - Obtiene todos los usuarios de un rol específico
   - Solo retorna usuarios activos
   - Retorna: array de usuarios

   cambiarPassword($id_usuario, $nueva_password)
   - Cambia la contraseña de un usuario
   - Hashea automáticamente la nueva contraseña


3.2. AdministradorModel.php
----------------------------
Ubicación: app/Models/AdministradorModel.php

PROPÓSITO:
Gestiona los perfiles adicionales de los administradores.

Métodos principales:
- obtenerPorUsuario($id_usuario): Obtiene perfil por ID de usuario
- obtenerConUsuario($id_admin): Obtiene perfil con datos de login


3.3. EmpleadoModel.php
----------------------
Ubicación: app/Models/EmpleadoModel.php

PROPÓSITO:
Gestiona los perfiles adicionales de los empleados/barberos.

Métodos principales:
- obtenerPorUsuario($id_usuario): Obtiene perfil por ID de usuario
- obtenerConUsuario($id_empleado): Obtiene perfil con datos de login
- obtenerActivos(): Lista solo empleados activos


3.4. ClienteModel.php
---------------------
Ubicación: app/Models/ClienteModel.php

PROPÓSITO:
Gestiona los perfiles adicionales de los clientes.

Métodos principales:
- obtenerPorUsuario($id_usuario): Obtiene perfil por ID de usuario
- obtenerConUsuario($id_cliente): Obtiene perfil con datos de login


================================================================================
4. CONTROLADOR DE AUTENTICACIÓN
================================================================================

4.1. Auth.php
-------------
Ubicación: app/Controllers/Auth.php

PROPÓSITO:
Gestiona todas las operaciones de login, logout y redirección según roles.

MÉTODOS PRINCIPALES:

login()
-------
- Muestra el formulario de login
- Si ya hay sesión activa, redirige según rol
- Vista: app/Views/auth/login.php

procesarLogin()
---------------
FUNCIONALIDAD:
1. Recibe email y password por POST
2. Valida que los campos no estén vacíos
3. Verifica credenciales con UsuarioModel
4. Si son correctas:
   - Crea sesión con datos del usuario
   - Actualiza último acceso en BD
   - Redirige según el rol del usuario
5. Si son incorrectas:
   - Muestra mensaje de error
   - Retorna al formulario de login

DATOS ALMACENADOS EN SESIÓN:
- id_usuario: ID del usuario
- email: Correo electrónico
- rol: Tipo de usuario (admin/empleado/cliente)
- logged_in: true (bandera de sesión activa)

REDIRECCIONES POR ROL:
- admin → /admin/dashboard
- empleado → /empleado/dashboard
- cliente → /cliente/dashboard

logout()
--------
FUNCIONALIDAD:
1. Destruye todos los datos de sesión
2. Redirige a la página de login
3. Muestra mensaje de "Sesión cerrada exitosamente"


================================================================================
5. FILTROS DE SEGURIDAD
================================================================================

Los filtros son middleware que protegen las rutas y verifican permisos.

5.1. AuthFilter.php
-------------------
Ubicación: app/Filters/AuthFilter.php

PROPÓSITO:
Verifica que el usuario tenga una sesión activa.

FUNCIONAMIENTO:
- before(): Se ejecuta antes de acceder a una ruta
- Verifica si existe la variable de sesión 'logged_in'
- Si NO hay sesión: redirige a /login con mensaje de error
- Si hay sesión: permite el acceso


5.2. AdminFilter.php
--------------------
Ubicación: app/Filters/AdminFilter.php

PROPÓSITO:
Verifica que el usuario sea administrador.

FUNCIONAMIENTO:
- before(): Se ejecuta antes de acceder a rutas de admin
- Verifica que haya sesión activa (logged_in)
- Verifica que el rol sea 'admin'
- Si NO es admin: redirige a /login con mensaje de error
- Si es admin: permite el acceso


5.3. EmpleadoFilter.php
-----------------------
Ubicación: app/Filters/EmpleadoFilter.php

PROPÓSITO:
Verifica que el usuario sea empleado.

FUNCIONAMIENTO:
- before(): Se ejecuta antes de acceder a rutas de empleado
- Verifica que haya sesión activa (logged_in)
- Verifica que el rol sea 'empleado'
- Si NO es empleado: redirige a /login con mensaje de error
- Si es empleado: permite el acceso


5.4. ClienteFilter.php
----------------------
Ubicación: app/Filters/ClienteFilter.php

PROPÓSITO:
Verifica que el usuario sea cliente.

FUNCIONAMIENTO:
- before(): Se ejecuta antes de acceder a rutas de cliente
- Verifica que haya sesión activa (logged_in)
- Verifica que el rol sea 'cliente'
- Si NO es cliente: redirige a /login con mensaje de error
- Si es cliente: permite el acceso


================================================================================
6. CONFIGURACIÓN DE FILTROS
================================================================================

6.1. Filters.php
----------------
Ubicación: app/Config/Filters.php

REGISTRO DE FILTROS:
$aliases = [
    'auth'     => \App\Filters\AuthFilter::class,
    'admin'    => \App\Filters\AdminFilter::class,
    'empleado' => \App\Filters\EmpleadoFilter::class,
    'cliente'  => \App\Filters\ClienteFilter::class,
];

APLICACIÓN GLOBAL:
$globals = [
    'before' => [
        // 'auth' => ['except' => ['login', 'procesarLogin']]
    ],
];


================================================================================
7. CONFIGURACIÓN DE RUTAS
================================================================================

7.1. Routes.php
---------------
Ubicación: app/Config/Routes.php

RUTAS PÚBLICAS (sin autenticación):
------------------------------------
GET  /                    → Home::index
GET  /login              → Auth::login
POST /login              → Auth::procesarLogin
GET  /logout             → Auth::logout


RUTAS PROTEGIDAS - ADMINISTRADOR:
----------------------------------
Filtro: ['filter' => 'admin']

GET  /admin/dashboard    → Admin\Dashboard::index


RUTAS PROTEGIDAS - EMPLEADO:
-----------------------------
Filtro: ['filter' => 'empleado']

GET  /empleado/dashboard → Empleado\Dashboard::index


RUTAS PROTEGIDAS - CLIENTE:
----------------------------
Filtro: ['filter' => 'cliente']

GET  /cliente/dashboard  → Cliente\Dashboard::index


CÓMO FUNCIONAN LOS FILTROS EN RUTAS:
Cuando un usuario intenta acceder a una ruta protegida:

1. CodeIgniter ejecuta el filtro ANTES de llamar al controlador
2. El filtro verifica la sesión y los permisos
3. Si pasa la verificación: continúa al controlador
4. Si falla: redirige a /login con mensaje de error


================================================================================
8. CONTROLADORES POR ROL
================================================================================

8.1. Admin\Dashboard.php
-------------------------
Ubicación: app/Controllers/Admin/Dashboard.php
Namespace: App\Controllers\Admin

PROPÓSITO:
Panel de control para administradores.

index()
- Verifica sesión y rol
- Carga vista: app/Views/admin/dashboard.php
- Muestra información del administrador


8.2. Empleado\Dashboard.php
----------------------------
Ubicación: app/Controllers/Empleado/Dashboard.php
Namespace: App\Controllers\Empleado

PROPÓSITO:
Panel de control para empleados/barberos.

index()
- Verifica sesión y rol
- Carga vista: app/Views/empleado/dashboard.php
- Muestra información del empleado


8.3. Cliente\Dashboard.php
---------------------------
Ubicación: app/Controllers/Cliente/Dashboard.php
Namespace: App\Controllers\Cliente

PROPÓSITO:
Panel de control para clientes.

index()
- Verifica sesión y rol
- Carga vista: app/Views/cliente/dashboard.php
- Muestra información del cliente


================================================================================
9. VISTAS (VIEWS)
================================================================================

9.1. Layout Principal
---------------------
Ubicación: app/Views/layouts/main.php

PROPÓSITO:
Plantilla base para todas las páginas del sistema.

CARACTERÍSTICAS:
- Bootstrap 5 para diseño responsivo
- Navbar con logo y menú
- Muestra nombre de usuario si hay sesión
- Botón de logout si hay sesión
- Sistema de mensajes flash (éxito/error)
- Footer con información de copyright


9.2. Vista de Login
-------------------
Ubicación: app/Views/auth/login.php

PROPÓSITO:
Formulario de inicio de sesión.

ELEMENTOS:
- Logo de la barbería
- Campo de email
- Campo de contraseña
- Checkbox "Recordarme"
- Botón de "Iniciar Sesión"
- Enlace para registrarse
- Muestra mensajes de error/éxito


9.3. Vista Dashboard Admin
---------------------------
Ubicación: app/Views/admin/dashboard.php

PROPÓSITO:
Panel principal del administrador.

CARACTERÍSTICAS:
- Saludo personalizado al administrador
- Tarjetas con estadísticas
- Accesos rápidos a funciones principales:
  * Gestionar Usuarios
  * Gestionar Empleados
  * Gestionar Servicios
  * Ver Reportes
  * Configuración del Sistema


9.4. Vista Dashboard Empleado
------------------------------
Ubicación: app/Views/empleado/dashboard.php

PROPÓSITO:
Panel principal del empleado/barbero.

CARACTERÍSTICAS:
- Saludo personalizado al empleado
- Tarjetas con información relevante
- Accesos rápidos a:
  * Ver Mis Citas
  * Mi Horario
  * Mis Comisiones
  * Mi Perfil


9.5. Vista Dashboard Cliente
-----------------------------
Ubicación: app/Views/cliente/dashboard.php

PROPÓSITO:
Panel principal del cliente.

CARACTERÍSTICAS:
- Saludo personalizado al cliente
- Tarjetas con información útil
- Accesos rápidos a:
  * Nueva Cita
  * Mis Citas
  * Historial
  * Mi Perfil


================================================================================
10. SEGURIDAD IMPLEMENTADA
================================================================================

10.1. Protección de Contraseñas
--------------------------------
- Uso de password_hash() con algoritmo bcrypt
- NUNCA se almacenan contraseñas en texto plano
- Verificación con password_verify() para evitar timing attacks
- Hash diferente cada vez (salt automático)


10.2. Protección contra SQL Injection
--------------------------------------
- Uso de Query Builder de CodeIgniter
- Prepared Statements en consultas
- Validación de datos en el modelo


10.3. Protección de Rutas
--------------------------
- Filtros de autenticación en todas las rutas protegidas
- Verificación de roles antes de permitir acceso
- Redirección automática si no hay permisos


10.4. Gestión de Sesiones
--------------------------
- Sesiones nativas de CodeIgniter 4
- Regeneración de ID de sesión en login
- Destrucción completa de sesión en logout
- Verificación en cada petición


10.5. Validación de Datos
--------------------------
- Reglas de validación en modelos
- Mensajes de error personalizados
- Sanitización automática de entradas


================================================================================
11. FLUJO DE AUTENTICACIÓN
================================================================================

11.1. Proceso de Login
----------------------

1. Usuario accede a /login
   ↓
2. Se muestra formulario de login
   ↓
3. Usuario ingresa email y contraseña
   ↓
4. Envío de datos por POST a /login
   ↓
5. Auth::procesarLogin() recibe datos
   ↓
6. Validación de campos (no vacíos)
   ↓
7. UsuarioModel::verificarCredenciales()
   ↓
8. Buscar usuario por email
   ↓
9. Verificar que usuario esté activo
   ↓
10. Verificar contraseña con password_verify()
    ↓
11. Si es correcto:
    - Crear sesión con datos del usuario
    - Actualizar último acceso en BD
    - Redirigir según rol
    ↓
12. Si es incorrecto:
    - Mostrar mensaje de error
    - Volver al formulario


11.2. Proceso de Acceso a Rutas Protegidas
-------------------------------------------

1. Usuario intenta acceder a /admin/dashboard
   ↓
2. CodeIgniter ejecuta filtro 'admin'
   ↓
3. AdminFilter::before() se ejecuta
   ↓
4. Verifica si existe sesión activa
   ↓
5. Verifica si rol == 'admin'
   ↓
6. Si todo es correcto:
   - Permite acceso al controlador
   - Dashboard::index() se ejecuta
   - Se carga la vista
   ↓
7. Si falla alguna verificación:
   - Redirige a /login
   - Muestra mensaje de error


11.3. Proceso de Logout
------------------------

1. Usuario hace clic en "Cerrar Sesión"
   ↓
2. Petición GET a /logout
   ↓
3. Auth::logout() se ejecuta
   ↓
4. session()->destroy() elimina todos los datos
   ↓
5. Redirige a /login
   ↓
6. Muestra mensaje "Sesión cerrada exitosamente"


================================================================================
12. DATOS DE PRUEBA
================================================================================

12.1. Usuarios Predefinidos
----------------------------

ADMINISTRADOR:
--------------
Email: admin@barberia.com
Contraseña: ilich123
Rol: admin
Perfil: Admin Sistema - Gerente General
Teléfono: 1234567890


EMPLEADO/BARBERO:
-----------------
Email: empleado@barberia.com
Contraseña: ilich123
Rol: empleado
Perfil: Juan Barbero
Especialidad: Corte de cabello
Comisión: 15%
Teléfono: 0987654321


CLIENTE:
--------
Email: cliente@barberia.com
Contraseña: ilich123
Rol: cliente
Perfil: Carlos Cliente
Teléfono: 1122334455
Dirección: Calle Principal 123


================================================================================
13. INSTALACIÓN Y CONFIGURACIÓN
================================================================================

13.1. Requisitos
----------------
- PHP 8.0 o superior
- MySQL 5.7 o superior
- Composer
- CodeIgniter 4
- Extensiones PHP: mysqli, pdo_mysql, intl, mbstring


13.2. Pasos de Instalación
---------------------------

1. Clonar o copiar el proyecto
2. Instalar dependencias:
   composer install

3. Configurar base de datos:
   - Abrir phpMyAdmin
   - Importar archivo: database/barberia_db.sql
   - Verificar que se crearon todas las tablas

4. Configurar archivo .env:
   - Copiar env a .env
   - Configurar datos de conexión:
     database.default.hostname = localhost
     database.default.database = barberia_db
     database.default.username = root
     database.default.password =
     database.default.DBDriver = MySQLi

5. Configurar permisos:
   - Dar permisos de escritura a writable/

6. Iniciar servidor:
   php spark serve

7. Acceder al sistema:
   http://localhost:8080


================================================================================
14. TESTING DEL SISTEMA
================================================================================

14.1. Probar Login de Administrador
------------------------------------
1. Ir a: http://localhost:8080/login
2. Ingresar:
   Email: admin@barberia.com
   Contraseña: ilich123
3. Click en "Iniciar Sesión"
4. Verificar redirección a /admin/dashboard
5. Verificar que se muestra el dashboard del admin


14.2. Probar Filtros de Seguridad
----------------------------------
1. Cerrar sesión
2. Intentar acceder directamente a:
   http://localhost:8080/admin/dashboard
3. Verificar que redirige a /login
4. Verificar mensaje de error


14.3. Probar Cambio de Roles
-----------------------------
1. Login como cliente
2. Intentar acceder a /admin/dashboard
3. Verificar que muestra error de permisos
4. Verificar que no permite el acceso


14.4. Probar Logout
-------------------
1. Iniciar sesión con cualquier usuario
2. Click en "Cerrar Sesión"
3. Verificar que redirige a /login
4. Verificar que no se puede acceder a rutas protegidas
5. Verificar mensaje de éxito


================================================================================
15. POSIBLES MEJORAS FUTURAS
================================================================================

□ Implementar "Recordar contraseña" funcional
□ Agregar recuperación de contraseña por email
□ Sistema de verificación de email
□ Login con redes sociales (Google, Facebook)
□ Autenticación de dos factores (2FA)
□ Historial de accesos por usuario
□ Bloqueo automático tras múltiples intentos fallidos
□ Sistema de permisos granular (no solo roles)
□ API REST para autenticación con tokens JWT
□ Logs de auditoría para acciones importantes
□ Cambio de contraseña obligatorio al primer login
□ Política de expiración de contraseñas


================================================================================
16. SOLUCIÓN DE PROBLEMAS COMUNES
================================================================================

PROBLEMA: No puedo iniciar sesión
SOLUCIÓN:
1. Verificar que la base de datos está importada
2. Verificar credenciales (email y contraseña correctos)
3. Verificar que el usuario está activo en BD
4. Revisar logs en writable/logs/


PROBLEMA: Me redirige siempre a login
SOLUCIÓN:
1. Verificar que las sesiones estén habilitadas en .env
2. Verificar permisos de escritura en writable/session/
3. Limpiar cookies del navegador
4. Verificar configuración de filtros en Filters.php


PROBLEMA: No se aplican los filtros
SOLUCIÓN:
1. Verificar que los filtros están registrados en Filters.php
2. Verificar que las rutas tienen el filtro aplicado
3. Limpiar cache: php spark cache:clear
4. Reiniciar servidor de desarrollo


PROBLEMA: Error al importar base de datos
SOLUCIÓN:
1. Verificar que MySQL está corriendo
2. Verificar versión de MySQL (5.7+)
3. Importar tabla por tabla si falla
4. Verificar charset utf8mb4


================================================================================
17. CONTACTO Y SOPORTE
================================================================================

Para preguntas, problemas o sugerencias:
- Revisar esta documentación primero
- Consultar documentación oficial de CodeIgniter 4
- Revisar logs en writable/logs/
- Contactar al equipo de desarrollo


================================================================================
18. HISTORIAL DE VERSIONES
================================================================================

Versión 1.0 (Noviembre 2024)
-----------------------------
✓ Implementación inicial del sistema de autenticación
✓ Gestión de roles (admin, empleado, cliente)
✓ Filtros de seguridad
✓ Dashboards por rol
✓ Protección de rutas
✓ Sistema de sesiones
✓ Hash seguro de contraseñas


================================================================================
                            FIN DE LA DOCUMENTACIÓN
================================================================================
