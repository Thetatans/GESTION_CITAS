================================================================================
  EXPLICACI√ìN DETALLADA - C√ìMO FUNCIONA LA GENERACI√ìN DE PDFs
  Sistema de Gesti√≥n de Citas - Barber√≠a y Spa
================================================================================

AUTOR: Explicaci√≥n para Ilich Esteban Reyes Botia
FECHA: <?= date('Y-m-d H:i:s') ?>


================================================================================
¬øQU√â ES TCPDF?
================================================================================

TCPDF es una librer√≠a de PHP que permite crear documentos PDF de forma din√°mica.

CARACTER√çSTICAS:
- No requiere librer√≠as externas (funciona 100% con PHP)
- Soporta HTML para crear contenido
- Permite configurar m√°rgenes, fuentes, colores, etc.
- Puede crear tablas, im√°genes, gr√°ficos, etc.


================================================================================
PASO 1: INSTALACI√ìN DE TCPDF
================================================================================

COMANDO:
  composer require tecnickcom/tcpdf

UBICACI√ìN:
  Se instala en: vendor/tecnickcom/tcpdf/

USO EN PHP:
  require_once 'vendor/autoload.php';  // CodeIgniter ya lo hace autom√°ticamente


================================================================================
PASO 2: ESTRUCTURA DEL C√ìDIGO
================================================================================

El sistema tiene 2 m√©todos principales:

1. exportarPDF() - M√©todo p√∫blico (l√≠nea 189)
   - Recibe par√°metros desde la URL
   - Configura el PDF
   - Llama a los m√©todos privados seg√∫n el tipo

2. generarPDF*() - M√©todos privados (l√≠nea 311+)
   - generarPDFGeneral()
   - generarPDFEmpleado()
   - generarPDFServicio()
   - generarPDFRealizadas()


================================================================================
PASO 3: FLUJO COMPLETO DE GENERACI√ìN
================================================================================

USUARIO HACE CLICK EN "EXPORTAR PDF"
  ‚Üì
NAVEGADOR HACE REQUEST:
  URL: /admin/reportes/exportarPDF?tipo=empleado&fecha_inicio=2025-01-01&fecha_fin=2025-01-31
  ‚Üì
CONTROLADOR: exportarPDF()
  ‚Üì
1. Recibe par√°metros de la URL
2. Verifica que TCPDF est√© instalado
3. Crea instancia de TCPDF
4. Configura el PDF (m√°rgenes, autor, t√≠tulo)
5. Agrega p√°gina en blanco
6. Escribe t√≠tulo y per√≠odo
7. Llama al m√©todo espec√≠fico seg√∫n tipo
8. Genera el archivo PDF
9. Env√≠a el PDF al navegador para descarga


================================================================================
PASO 4: C√ìDIGO EXPLICADO L√çNEA POR L√çNEA
================================================================================

M√âTODO: exportarPDF() - L√≠nea 189
----------------------------------

// PASO 1: Obtener par√°metros de la URL
$tipo = $this->request->getGet('tipo') ?? 'general';
// Si viene ?tipo=empleado, entonces $tipo = 'empleado'
// Si no viene nada, por defecto es 'general'

$fechaInicio = $this->request->getGet('fecha_inicio') ?? date('Y-m-01');
// Si viene ?fecha_inicio=2025-01-01, usa esa fecha
// Si no, usa el primer d√≠a del mes actual

$fechaFin = $this->request->getGet('fecha_fin') ?? date('Y-m-t');
// Si viene ?fecha_fin=2025-01-31, usa esa fecha
// Si no, usa el √∫ltimo d√≠a del mes actual


// PASO 2: Verificar que TCPDF est√© instalado
if (!class_exists('TCPDF')) {
    return redirect()->back()->with('error', 'La librer√≠a TCPDF no est√° instalada...');
}
// Esto evita errores si alguien olvid√≥ instalar la librer√≠a


// PASO 3: Crear instancia de TCPDF
$pdf = new \TCPDF(PDF_PAGE_ORIENTATION, PDF_UNIT, PDF_PAGE_FORMAT, true, 'UTF-8', false);
//               ‚Üë                      ‚Üë         ‚Üë               ‚Üë      ‚Üë        ‚Üë
//               Orientaci√≥n            Unidad    Formato         Unicode UTF-8   Sin cach√©
//               (Portrait/Landscape)   (mm, pt)  (A4, Letter)

// EXPLICACI√ìN DE PAR√ÅMETROS:
// - PDF_PAGE_ORIENTATION: 'P' = Portrait (vertical), 'L' = Landscape (horizontal)
// - PDF_UNIT: 'mm' = mil√≠metros, 'pt' = puntos, 'cm' = cent√≠metros
// - PDF_PAGE_FORMAT: 'A4', 'Letter', etc.
// - true: Usar Unicode
// - 'UTF-8': Codificaci√≥n (para caracteres especiales como √±, √°, √©)
// - false: No usar cach√© de disco


// PASO 4: Configurar metadatos del PDF
$pdf->SetCreator('Sistema de Gesti√≥n de Citas');
// Qui√©n cre√≥ el PDF (se ve en Propiedades del archivo)

$pdf->SetAuthor('Barber√≠a y Spa');
// Autor del documento

$pdf->SetTitle('Reporte de Citas');
// T√≠tulo del documento (aparece en la pesta√±a del navegador)

$pdf->SetSubject('Reporte');
// Tema del documento


// PASO 5: Configurar m√°rgenes
$pdf->SetMargins(15, 15, 15);
//                ‚Üë   ‚Üë   ‚Üë
//                Izq Top Der
// En mil√≠metros (si usaste 'mm' como unidad)

$pdf->SetHeaderMargin(5);
// Espacio entre el header y el contenido

$pdf->SetFooterMargin(10);
// Espacio entre el contenido y el footer


// PASO 6: Agregar una p√°gina
$pdf->AddPage();
// Crea una p√°gina en blanco donde escribir


// PASO 7: Escribir t√≠tulo
$pdf->SetFont('helvetica', 'B', 16);
//            ‚Üë           ‚Üë    ‚Üë
//            Fuente      Bold Tama√±o

$pdf->Cell(0, 10, 'REPORTE DE CITAS', 0, 1, 'C');
//         ‚Üë  ‚Üë   ‚Üë                  ‚Üë  ‚Üë  ‚Üë
//         W  H   Texto              B  LN Align
//
// EXPLICACI√ìN:
// - 0 = Ancho autom√°tico (ocupa todo el ancho disponible)
// - 10 = Alto de la celda (mm)
// - 'REPORTE DE CITAS' = Texto a mostrar
// - 0 = Sin borde (1 = con borde)
// - 1 = Salto de l√≠nea despu√©s (0 = no, 1 = s√≠)
// - 'C' = Centrado (L=izquierda, R=derecha, C=centro)

$pdf->Ln(5);
// Salto de l√≠nea de 5mm


// PASO 8: Escribir per√≠odo
$pdf->SetFont('helvetica', '', 10);
// Fuente normal (no bold), tama√±o 10

$pdf->Cell(0, 5, 'Per√≠odo: 01/01/2025 - 31/01/2025', 0, 1, 'C');


// PASO 9: Llamar al m√©todo espec√≠fico seg√∫n tipo
switch ($tipo) {
    case 'empleado':
        $this->generarPDFEmpleado($pdf, $fechaInicio, $fechaFin);
        break;
    case 'servicio':
        $this->generarPDFServicio($pdf, $fechaInicio, $fechaFin);
        break;
    case 'realizadas':
        $this->generarPDFRealizadas($pdf, $fechaInicio, $fechaFin);
        break;
    default:
        $this->generarPDFGeneral($pdf, $fechaInicio, $fechaFin);
        break;
}


// PASO 10: Generar y descargar el PDF
$nombreArchivo = 'reporte_' . $tipo . '_' . date('Y-m-d') . '.pdf';
// Ejemplo: reporte_empleado_2025-01-15.pdf

$pdf->Output($nombreArchivo, 'D');
//            ‚Üë              ‚Üë
//            Nombre         Destino
//
// DESTINOS:
// - 'I' = Inline (mostrar en el navegador)
// - 'D' = Download (descargar archivo)
// - 'F' = File (guardar en servidor)
// - 'S' = String (devolver como string)


================================================================================
PASO 5: M√âTODO PRIVADO - generarPDFEmpleado()
================================================================================

Este m√©todo genera el contenido espec√≠fico del reporte por empleado.

C√ìDIGO COMPLETO:

private function generarPDFEmpleado($pdf, $fechaInicio, $fechaFin)
{
    // PASO 1: Obtener datos de la base de datos
    $reporte = $this->citasModel->obtenerReportePorEmpleado($fechaInicio, $fechaFin);
    // Esto devuelve un array con todos los empleados y sus estad√≠sticas

    // PASO 2: Configurar fuente para subt√≠tulo
    $pdf->SetFont('helvetica', 'B', 12);
    $pdf->Cell(0, 8, 'Reporte por Empleado', 0, 1);

    // PASO 3: Configurar fuente para la tabla
    $pdf->SetFont('helvetica', '', 9);

    // PASO 4: Crear tabla HTML
    $html = '<table border="1" cellpadding="4">
        <tr style="background-color:#1e3a5f;color:white;">
            <th width="30%">Empleado</th>
            <th width="15%">Total Citas</th>
            <th width="15%">Completadas</th>
            <th width="15%">Canceladas</th>
            <th width="25%">Ingresos</th>
        </tr>';

    // PASO 5: Recorrer los datos y agregar filas
    foreach ($reporte as $emp) {
        $html .= '<tr>
            <td>' . $emp['nombre'] . ' ' . $emp['apellido'] . '</td>
            <td align="center">' . $emp['total_citas'] . '</td>
            <td align="center">' . $emp['citas_completadas'] . '</td>
            <td align="center">' . $emp['citas_canceladas'] . '</td>
            <td align="right">$' . number_format($emp['ingresos_generados'], 2) . '</td>
        </tr>';
    }

    // PASO 6: Cerrar la tabla
    $html .= '</table>';

    // PASO 7: Escribir el HTML en el PDF
    $pdf->writeHTML($html, true, false, true, false, '');
    //               ‚Üë     ‚Üë     ‚Üë      ‚Üë     ‚Üë      ‚Üë
    //               HTML  LN    Fill   Res   Auto   Align
    //
    // EXPLICACI√ìN:
    // - $html: El c√≥digo HTML a renderizar
    // - true: Salto de l√≠nea despu√©s
    // - false: No rellenar el fondo
    // - true: Resetear altura de l√≠nea
    // - false: No ajustar autom√°ticamente
    // - '': Alineaci√≥n (vac√≠o = por defecto)
}


================================================================================
PASO 6: EXPLICACI√ìN DEL HTML EN EL PDF
================================================================================

TCPDF SOPORTA UN SUBCONJUNTO DE HTML:

ETIQUETAS SOPORTADAS:
‚úì <table>, <tr>, <td>, <th>
‚úì <b>, <strong>, <i>, <em>, <u>
‚úì <br>, <p>, <div>
‚úì <h1>, <h2>, <h3>, etc.
‚úì <ul>, <ol>, <li>
‚úì <img>

ATRIBUTOS SOPORTADOS:
‚úì style="background-color:...; color:...; font-size:..."
‚úì width="..." (en porcentaje o p√≠xeles)
‚úì border="..."
‚úì cellpadding="..."
‚úì align="center|left|right"

EJEMPLO DE TABLA HTML:

<table border="1" cellpadding="5">
  <!-- HEADER con fondo azul oscuro -->
  <tr style="background-color:#1e3a5f;color:white;">
    <th width="30%">Empleado</th>
    <th width="15%">Total Citas</th>
    <th width="25%">Ingresos</th>
  </tr>

  <!-- DATOS -->
  <tr>
    <td>Juan P√©rez</td>
    <td align="center">25</td>
    <td align="right">$1,250.00</td>
  </tr>

  <tr>
    <td>Mar√≠a Garc√≠a</td>
    <td align="center">30</td>
    <td align="right">$1,500.00</td>
  </tr>
</table>

RESULTADO EN PDF:
  Se renderiza como una tabla profesional con:
  - Header azul oscuro con texto blanco
  - Bordes visibles
  - Datos alineados seg√∫n especificaci√≥n


================================================================================
PASO 7: EJEMPLO PR√ÅCTICO - CREAR TU PROPIO PDF
================================================================================

Aqu√≠ te muestro c√≥mo crear un PDF simple desde cero:

ARCHIVO: test_pdf.php
----------------------

<?php
require_once 'vendor/autoload.php';

// 1. Crear instancia
$pdf = new TCPDF('P', 'mm', 'A4', true, 'UTF-8', false);

// 2. Configurar
$pdf->SetCreator('Mi Nombre');
$pdf->SetTitle('Mi Primer PDF');
$pdf->SetMargins(15, 15, 15);

// 3. Agregar p√°gina
$pdf->AddPage();

// 4. T√≠tulo
$pdf->SetFont('helvetica', 'B', 20);
$pdf->Cell(0, 10, 'Mi Primer PDF con TCPDF', 0, 1, 'C');
$pdf->Ln(5);

// 5. Texto normal
$pdf->SetFont('helvetica', '', 12);
$pdf->Cell(0, 10, 'Este es un ejemplo de PDF generado con PHP', 0, 1, 'L');
$pdf->Ln(5);

// 6. Tabla HTML
$html = '
<table border="1" cellpadding="5" style="width:100%;">
    <tr style="background-color:#1e3a5f;color:white;">
        <th>Producto</th>
        <th>Cantidad</th>
        <th>Precio</th>
    </tr>
    <tr>
        <td>Corte de cabello</td>
        <td align="center">3</td>
        <td align="right">$50.00</td>
    </tr>
    <tr>
        <td>Afeitado</td>
        <td align="center">2</td>
        <td align="right">$30.00</td>
    </tr>
    <tr style="background-color:#f0f0f0;">
        <td colspan="2" align="right"><b>TOTAL:</b></td>
        <td align="right"><b>$80.00</b></td>
    </tr>
</table>
';

$pdf->writeHTML($html, true, false, true, false, '');

// 7. Generar y descargar
$pdf->Output('mi_reporte.pdf', 'D');
?>


C√ìMO PROBARLO:
--------------
1. Crear archivo: public/test_pdf.php
2. Pegar el c√≥digo anterior
3. Acceder a: http://localhost/gestion_citas/public/test_pdf.php
4. Se descargar√° autom√°ticamente el PDF


================================================================================
PASO 8: M√âTODOS √öTILES DE TCPDF
================================================================================

CONFIGURACI√ìN:
--------------
$pdf->SetFont(familia, estilo, tama√±o)
  - familia: 'helvetica', 'times', 'courier', etc.
  - estilo: 'B' (bold), 'I' (italic), 'U' (underline), '' (normal)
  - tama√±o: n√∫mero (en puntos)

$pdf->SetTextColor(r, g, b)
  - r, g, b: valores de 0 a 255
  - Ejemplo: $pdf->SetTextColor(255, 0, 0) = rojo

$pdf->SetFillColor(r, g, b)
  - Para fondos de celdas

$pdf->SetDrawColor(r, g, b)
  - Para bordes y l√≠neas


CONTENIDO:
----------
$pdf->Cell(w, h, texto, border, ln, align, fill)
  - w: ancho (0 = autom√°tico)
  - h: alto
  - texto: texto a mostrar
  - border: 0=sin borde, 1=con borde
  - ln: 0=misma l√≠nea, 1=nueva l√≠nea
  - align: 'L', 'C', 'R'
  - fill: true/false (usar color de fondo)

$pdf->MultiCell(w, h, texto, border, align, fill)
  - Igual que Cell pero permite texto multil√≠nea

$pdf->Write(h, texto)
  - Escribe texto con salto autom√°tico

$pdf->Ln(h)
  - Salto de l√≠nea de altura h

$pdf->writeHTML(html)
  - Renderiza HTML


IM√ÅGENES:
---------
$pdf->Image(archivo, x, y, w, h)
  - archivo: ruta de la imagen
  - x, y: posici√≥n
  - w, h: ancho y alto


L√çNEAS Y FORMAS:
----------------
$pdf->Line(x1, y1, x2, y2)
  - Dibuja una l√≠nea

$pdf->Rect(x, y, w, h)
  - Dibuja un rect√°ngulo


================================================================================
PASO 9: TIPS Y MEJORES PR√ÅCTICAS
================================================================================

1. SIEMPRE VERIFICAR SI TCPDF EST√Å INSTALADO
   if (!class_exists('TCPDF')) {
       die('TCPDF no est√° instalado');
   }


2. USAR HTML PARA TABLAS COMPLEJAS
   Es m√°s f√°cil que usar Cell() para cada celda


3. FORMATEAR N√öMEROS
   number_format($numero, 2)  // 2 decimales
   number_format($numero, 0)  // sin decimales


4. ESCAPAR HTML SI ES NECESARIO
   htmlspecialchars($texto)  // Evita problemas con <, >, &


5. AJUSTAR M√ÅRGENES SEG√öN NECESIDAD
   - Reportes simples: 15mm
   - Reportes con mucho contenido: 10mm
   - Reportes formales: 20mm


6. USAR DIFERENTES TAMA√ëOS DE FUENTE
   - T√≠tulo: 16-20
   - Subt√≠tulo: 12-14
   - Texto normal: 10-12
   - Texto peque√±o: 8-9


7. ORGANIZAR C√ìDIGO
   - Un m√©todo por tipo de reporte
   - Reutilizar c√≥digo com√∫n
   - Usar funciones helper si es necesario


================================================================================
PASO 10: DIFERENCIAS CON EXCEL
================================================================================

PDF vs EXCEL:
-------------

PDF (TCPDF):
  ‚úì Formato fijo (no editable)
  ‚úì Mismo aspecto en todos los dispositivos
  ‚úì Para imprimir o compartir
  ‚úì M√°s profesional para reportes oficiales
  ‚úì Usa HTML para crear contenido

EXCEL (PhpSpreadsheet):
  ‚úì Formato editable
  ‚úì Permite c√°lculos y f√≥rmulas
  ‚úì Para an√°lisis de datos
  ‚úì M√°s flexible para el usuario
  ‚úì Usa API de programaci√≥n


CU√ÅNDO USAR CADA UNO:
---------------------

USA PDF CUANDO:
  - Necesites un documento formal
  - Vayas a imprimir
  - Quieras que no se modifique
  - Sea para presentar a clientes/jefes

USA EXCEL CUANDO:
  - El usuario necesite editar
  - Quieras hacer c√°lculos adicionales
  - Necesites gr√°ficos editables
  - Sea para an√°lisis de datos


================================================================================
PASO 11: TROUBLESHOOTING
================================================================================

ERROR: Class 'TCPDF' not found
SOLUCI√ìN: composer require tecnickcom/tcpdf


ERROR: El PDF se descarga vac√≠o
SOLUCI√ìN: Verificar que no haya espacios antes de <?php


ERROR: Caracteres raros (√±, √°, √©)
SOLUCI√ìN: Usar UTF-8 en el constructor
  new TCPDF('P', 'mm', 'A4', true, 'UTF-8', false)


ERROR: La tabla se sale de la p√°gina
SOLUCI√ìN: Ajustar los width de las columnas
  La suma de width debe ser <= 100%


ERROR: El PDF no se descarga
SOLUCI√ìN: Verificar que no haya echo o print antes de Output()


================================================================================
PASO 12: EJEMPLO COMPLETO DEL FLUJO
================================================================================

USUARIO ‚Üí CLICK EN "EXPORTAR PDF"
  ‚Üì
NAVEGADOR ‚Üí GET /admin/reportes/exportarPDF?tipo=empleado&fecha_inicio=2025-01-01
  ‚Üì
CONTROLADOR ‚Üí exportarPDF()
  ‚Üì
  1. Recibe: tipo='empleado', fecha_inicio='2025-01-01'
  2. Verifica TCPDF instalado ‚úì
  3. Crea: $pdf = new TCPDF(...)
  4. Configura: SetMargins, SetAuthor, etc.
  5. Agrega p√°gina: AddPage()
  6. Escribe t√≠tulo: "REPORTE DE CITAS"
  7. Escribe per√≠odo: "01/01/2025 - 31/01/2025"
  8. Llama: generarPDFEmpleado($pdf, ...)
     ‚Üì
     - Obtiene datos: $reporte = obtenerReportePorEmpleado()
     - Crea HTML: <table>...</table>
     - Escribe HTML: writeHTML($html)
  9. Genera: $pdf->Output('reporte_empleado_2025-01-15.pdf', 'D')
  ‚Üì
NAVEGADOR ‚Üê RECIBE ARCHIVO PDF
  ‚Üì
USUARIO ‚Üê DESCARGA EL ARCHIVO


================================================================================
RESUMEN FINAL
================================================================================

PASOS B√ÅSICOS PARA CREAR UN PDF:

1. Instalar TCPDF
   composer require tecnickcom/tcpdf

2. Crear instancia
   $pdf = new TCPDF('P', 'mm', 'A4', true, 'UTF-8', false);

3. Configurar
   $pdf->SetMargins(15, 15, 15);
   $pdf->SetFont('helvetica', '', 12);

4. Agregar p√°gina
   $pdf->AddPage();

5. Escribir contenido
   $pdf->Cell(0, 10, 'T√≠tulo', 0, 1, 'C');
   $pdf->writeHTML('<table>...</table>');

6. Generar y descargar
   $pdf->Output('reporte.pdf', 'D');


¬°ESO ES TODO! üéâ

Con esto ya sabes:
‚úì Qu√© es TCPDF
‚úì C√≥mo instalarlo
‚úì C√≥mo crear un PDF b√°sico
‚úì C√≥mo crear tablas con HTML
‚úì C√≥mo funciona el c√≥digo de reportes
‚úì C√≥mo crear tus propios PDFs


================================================================================
FIN DE LA EXPLICACI√ìN
================================================================================
